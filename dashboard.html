<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FitSync</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard">
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">Loading...</p>
        </div>
    </div>

    <nav class="navbar">
        <div class="container">
            <div class="logo">üí™ FitSync</div>
            <div class="nav-links">
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="progress.html">Progress</a>
                <a href="partner.html">Partner</a>
                <a href="settings.html">Settings</a>
            </div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">JD</div>
                <span id="userName">Loading...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="grid">
            <div class="stat-card">
                <div class="stat-label">Current Streak</div>
                <div class="stat-value" id="currentStreak">0 üî•</div>
                <div class="stat-change">Keep it going!</div>
            </div>
            <div class="stat-card secondary">
                <div class="stat-label">Today's Progress</div>
                <div class="stat-value" id="todayProgress">0%</div>
                <div class="stat-change" id="progressText">0 of 0 completed</div>
            </div>
            <div class="stat-card success">
                <div class="stat-label">Total Workouts</div>
                <div class="stat-value" id="totalWorkouts">0</div>
                <div class="stat-change" id="totalChange">All time</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div>
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Today's Workout</div>
                            <div class="card-subtitle" id="todayDate">Loading...</div>
                        </div>
                        <span class="badge badge-warning" id="workoutBadge">Not Started</span>
                    </div>

                    <div id="workoutList"></div>

                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #7F8C8D;">Overall Progress</span>
                            <span style="color: var(--primary); font-weight: 600;" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üé• Today's Breathwork - Day <span id="breathworkDay">1</span></div>
                    </div>
                    <div id="breathworkPlayer" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: var(--bg-dark);">
                        <iframe id="youtubeFrame" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 12px; font-size: 0.9rem;">
                        Check the breathwork box after watching the video
                    </p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚è∞ Your Morning Schedule</div>
                    </div>
                    <div class="timeline" id="scheduleTimeline"></div>
                </div>
            </div>

            <div>
                <div id="partnerCard" class="partner-card" style="display: none;">
                    <div class="partner-avatar" id="partnerAvatar">??</div>
                    <div class="partner-info">
                        <div class="partner-name" id="partnerName">No Partner</div>
                        <div class="partner-status" id="partnerStatus">Link a partner in setup</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">This Week</div>
                    </div>
                    <div id="weeklyStats"></div>
                </div>

                <div class="alert alert-info">
                    <span>üì±</span>
                    <div>
                        <strong>Accountability Alert</strong><br>
                        <small id="alertInfo">Your partner will be notified at 8:00 PM if you haven't completed your workout.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config-secrets.js"></script>
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="sheets-api.js"></script>
    <script src="breathwork-videos.js"></script>

    <script>
        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        let currentUser = null;
        let userData = null;
        let userWorkouts = [];
        let todayLogs = [];

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                loadDashboard();
            }
        });

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function loadDashboard() {
            showLoading('Loading your dashboard...');
            try {
                await SheetsAPI.init();
                const userRow = await SheetsAPI.getUserByEmail(currentUser.email);
                
                if (!userRow) {
                    window.location.href = 'setup.html';
                    return;
                }

                userData = {
                    userId: userRow[0],
                    name: userRow[1],
                    email: userRow[2],
                    telegram: userRow[3],
                    workTime: userRow[4],
                    commute: parseInt(userRow[5]),
                    grooming: parseInt(userRow[6]),
                    partnerId: userRow[7],
                    alertTime: userRow[8],
                    breathworkStartDate: userRow[11] || new Date().toISOString().split('T')[0]
                };

                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userAvatar').textContent = getInitials(userData.name);

                await SheetsAPI.updateUserLastLogin(currentUser.email);
                await loadWorkouts();
                await loadTodayLogs();
                await loadStats();
                generateSchedule();
                await loadPartnerInfo();
                await checkSkippedBreathwork();
                loadBreathworkVideo();

                const today = new Date();
                document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', { 
                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
                });

                hideLoading();
            } catch (error) {
                console.error('Dashboard load error:', error);
                alert('Failed to load dashboard: ' + error.message);
                hideLoading();
            }
        }

        async function checkSkippedBreathwork() {
            const shouldPrompt = await shouldShowSkipPrompt(userData.userId);
            if (shouldPrompt) {
                showSkipDayPrompt(
                    async () => {
                        await SheetsAPI.updateUser(currentUser.email, {
                            breathworkStartDate: new Date().toISOString().split('T')[0]
                        });
                        userData.breathworkStartDate = new Date().toISOString().split('T')[0]

;
                        loadBreathworkVideo();
                    },
                    () => {
                        loadBreathworkVideo();
                    }
                );
            } else {
                loadBreathworkVideo();
            }
        }

        function loadBreathworkVideo() {
            const dayNumber = getCurrentDayNumber(userData.breathworkStartDate);
            const embedUrl = getVideoEmbedUrl(dayNumber);
            document.getElementById('youtubeFrame').src = embedUrl;
            document.getElementById('breathworkDay').textContent = dayNumber;
        }

        async function loadWorkouts() {
            userWorkouts = await SheetsAPI.getWorkoutsByUserId(userData.userId);
            renderWorkoutList();
        }

        async function loadTodayLogs() {
            todayLogs = await SheetsAPI.getTodayLogs(userData.userId);
            updateProgress();
        }

        function renderWorkoutList() {
            const container = document.getElementById('workoutList');
            container.innerHTML = '';
            userWorkouts.forEach(workout => {
                const workoutId = workout[0];
                const isCompleted = todayLogs.some(log => log[3] === workoutId);
                const div = document.createElement('div');
                div.className = 'workout-item' + (isCompleted ? ' completed' : '');
                div.innerHTML = `
                    <input type="checkbox" class="workout-checkbox" ${isCompleted ? 'checked' : ''} 
                           onchange="toggleWorkout('${workoutId}', this.checked)">
                    <div class="workout-details">
                        <div class="workout-name">${workout[2]}</div>
                        <div class="workout-meta">${workout[3]} ¬∑ <span class="workout-time">${workout[4]} min</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function toggleWorkout(workoutId, checked) {
            showLoading(checked ? 'Saving...' : 'Removing...');
            try {
                if (checked) {
                    await SheetsAPI.logWorkoutCompletion(userData.userId, workoutId);
                } else {
                    await SheetsAPI.removeWorkoutCompletion(userData.userId, workoutId);
                }
                await loadTodayLogs();
                await loadStats();
                hideLoading();
            } catch (error) {
                console.error('Toggle error:', error);
                alert('Failed to update: ' + error.message);
                hideLoading();
                location.reload();
            }
        }

        function updateProgress() {
            const total = userWorkouts.length;
            const completed = todayLogs.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            document.getElementById('todayProgress').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} completed`;
            document.getElementById('progressPercent').textContent = percentage + '%';
            document.getElementById('progressBar').style.width = percentage + '%';
            const badge = document.getElementById('workoutBadge');
            if (percentage === 100) {
                badge.className = 'badge badge-success';
                badge.textContent = 'Complete ‚úì';
            } else if (percentage > 0) {
                badge.className = 'badge badge-warning';
                badge.textContent = 'In Progress';
            } else {
                badge.className = 'badge badge-danger';
                badge.textContent = 'Not Started';
            }
        }

        async function loadStats() {
            const stats = await SheetsAPI.getUserStats(userData.userId);
            document.getElementById('currentStreak').textContent = stats.currentStreak + ' üî•';
            document.getElementById('totalWorkouts').textContent = stats.totalWorkouts;
        }

        function generateSchedule() {
            const workTime = parseTime(userData.workTime);
            const schedule = [];
            let currentTime = new Date(workTime);
            currentTime.setMinutes(currentTime.getMinutes() - userData.commute);
            schedule.unshift({ time: formatTime(currentTime), activity: 'Leave for Work', desc: `${userData.commute} min commute` });
            currentTime.setMinutes(currentTime.getMinutes() - userData.grooming);
            schedule.unshift({ time: formatTime(currentTime), activity: 'Shower & Grooming', desc: `${userData.grooming} minutes` });
            const sortedWorkouts = [...userWorkouts].sort((a, b) => parseInt(b[5]) - parseInt(a[5]));
            sortedWorkouts.forEach(workout => {
                currentTime.setMinutes(currentTime.getMinutes() - parseInt(workout[4]));
                schedule.unshift({ time: formatTime(currentTime), activity: workout[2], desc: workout[3] });
            });
            schedule.push({ time: userData.workTime, activity: 'Arrive at Work', desc: 'üéØ' });
            const container = document.getElementById('scheduleTimeline');
            container.innerHTML = '';
            schedule.forEach(item => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.innerHTML = `<div class="timeline-time">${item.time}</div><div class="timeline-content"><strong>${item.activity}</strong> - ${item.desc}</div>`;
                container.appendChild(div);
            });
        }

        async function loadPartnerInfo() {
            if (!userData.partnerId) return;
            const users = await SheetsAPI.getUsers();
            const partnerRow = users.find(row => row[0] === userData.partnerId);
            if (partnerRow) {
                document.getElementById('partnerCard').style.display = 'flex';
                document.getElementById('partnerName').textContent = partnerRow[1];
                document.getElementById('partnerAvatar').textContent = getInitials(partnerRow[1]);
                const partnerLogs = await SheetsAPI.getTodayLogs(userData.partnerId);
                const partnerWorkouts = await SheetsAPI.getWorkoutsByUserId(userData.partnerId);
                if (partnerLogs.length === partnerWorkouts.length && partnerWorkouts.length > 0) {
                    document.getElementById('partnerStatus').textContent = '‚úÖ Completed workout today';
                } else if (partnerLogs.length > 0) {
                    document.getElementById('partnerStatus').textContent = `‚è≥ ${partnerLogs.length}/${partnerWorkouts.length} exercises done`;
                } else {
                    document.getElementById('partnerStatus').textContent = '‚ùå Not started yet';
                }
            }
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            return date;
        }

        function formatTime(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${String(minutes).padStart(2, '0')} ${ampm}`;
        }
    </script>
</body>
</html>
