<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitSync - Login</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="auth-container">
            <div class="logo-section">
                <h1 class="logo">üí™ FitSync</h1>
                <p class="tagline">Stay accountable. Stay fit. Together.</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2>Welcome Back</h2>
                <div id="loginError" class="error-message" style="display: none;"></div>
                <form id="loginFormElement" onsubmit="return false;">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                    </div>
                    <button type="submit" onclick="handleLogin()" class="btn btn-primary">
                        <span id="loginBtnText">Log In</span>
                        <span id="loginSpinner" class="spinner" style="display: none;"></span>
                    </button>
                    <p class="form-footer">
                        Don't have an account? <a href="#" onclick="showSignup()">Sign up</a>
                    </p>
                    <p class="form-footer">
                        <a href="#" onclick="showReset()">Forgot password?</a>
                    </p>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="auth-form" style="display: none;">
                <h2>Create Account</h2>
                <div id="signupError" class="error-message" style="display: none;"></div>
                <div id="signupSuccess" class="success-message" style="display: none;"></div>
                <form id="signupFormElement" onsubmit="return false;">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Doe" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="At least 6 characters" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="signupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" autocomplete="new-password">
                    </div>
                    <button type="submit" onclick="handleSignup()" class="btn btn-primary">
                        <span id="signupBtnText">Create Account</span>
                        <span id="signupSpinner" class="spinner" style="display: none;"></span>
                    </button>
                    <p class="form-footer">
                        Already have an account? <a href="#" onclick="showLogin()">Log in</a>
                    </p>
                </form>
            </div>

            <!-- Password Reset -->
            <div id="resetForm" class="auth-form" style="display: none;">
                <h2>Reset Password</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Enter your email and we'll send you a reset link.</p>
                <div id="resetError" class="error-message" style="display: none;"></div>
                <div id="resetSuccess" class="success-message" style="display: none;"></div>
                <form id="resetFormElement" onsubmit="return false;">
                    <div class="form-group">
                        <label for="resetEmail">Email</label>
                        <input type="email" id="resetEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    <button type="submit" onclick="handlePasswordReset()" class="btn btn-primary">
                        <span id="resetBtnText">Send Reset Link</span>
                        <span id="resetSpinner" class="spinner" style="display: none;"></span>
                    </button>
                    <p class="form-footer">
                        <a href="#" onclick="showLogin()">Back to login</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <script src="config-secrets.js"></script>
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="sheets-api.js"></script>

    <script>
        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();

        auth.onAuthStateChanged((user) => {
            if (user && user.emailVerified) {
                checkUserSetup(user);
            }
        });

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'none';
            clearErrors();
        }

        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('resetForm').style.display = 'none';
            clearErrors();
        }

        function showReset() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'block';
            clearErrors();
        }

        function clearErrors() {
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        function setLoading(btnTextId, spinnerId, loading) {
            const btn = document.getElementById(btnTextId);
            const spinner = document.getElementById(spinnerId);
            if (btn) btn.style.display = loading ? 'none' : 'inline';
            if (spinner) spinner.style.display = loading ? 'inline-block' : 'none';
        }

        async function handleLogin() {
            clearErrors();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('loginError', 'Please fill in all fields');
                return;
            }

            setLoading('loginBtnText', 'loginSpinner', true);

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    showError('loginError', '‚ö†Ô∏è Please verify your email before logging in. Check your inbox (and spam folder).');
                    await auth.signOut();
                    setLoading('loginBtnText', 'loginSpinner', false);
                    return;
                }

                await checkUserSetup(user);
            } catch (error) {
                setLoading('loginBtnText', 'loginSpinner', false);
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‚ùå No account found with this email. Please sign up first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = '‚ùå Incorrect password. Try again or reset your password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‚ùå Invalid email address format.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = '‚ö†Ô∏è Too many failed login attempts. Please try again later or reset your password.';
                }
                
                showError('loginError', errorMessage);
            }
        }

        async function handleSignup() {
            clearErrors();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;

            if (!name || !email || !password || !confirmPassword) {
                showError('signupError', 'Please fill in all fields');
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                showError('signupError', '‚ùå Please enter a valid email address (e.g., name@example.com)');
                return;
            }

            if (password !== confirmPassword) {
                showError('signupError', '‚ùå Passwords do not match. Please check and try again.');
                return;
            }

            if (password.length < 6) {
                showError('signupError', '‚ùå Password must be at least 6 characters long.');
                return;
            }

            setLoading('signupBtnText', 'signupSpinner', true);

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                await user.updateProfile({ displayName: name });
                await user.sendEmailVerification();
                await auth.signOut();

                showSuccess('signupSuccess', 
                    `‚úÖ Account created successfully!\n\nüìß Verification email sent to: ${email}\n\n‚ö†Ô∏è Please check your inbox AND spam folder.\n\nüîó Click the verification link before logging in.`
                );
                
                document.getElementById('signupFormElement').reset();
                setLoading('signupBtnText', 'signupSpinner', false);

                setTimeout(() => showLogin(), 5000);

            } catch (error) {
                setLoading('signupBtnText', 'signupSpinner', false);
                console.error('Signup error:', error);
                
                let errorMessage = 'Signup failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = '‚ùå An account with this email already exists.\n\nPlease log in instead, or use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‚ùå Invalid email address format. Please check and try again.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = '‚ùå Password is too weak.\n\nUse at least 6 characters with a mix of letters and numbers.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = '‚ùå Email/password authentication is not enabled.\n\nPlease contact support.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'üåê Network error. Please check your internet connection and try again.';
                }
                
                showError('signupError', errorMessage);
            }
        }

        async function handlePasswordReset() {
            clearErrors();
            const email = document.getElementById('resetEmail').value.trim();

            if (!email) {
                showError('resetError', 'Please enter your email address');
                return;
            }

            if (!/\S+@\S+\.\S+/.test(email)) {
                showError('resetError', '‚ùå Please enter a valid email address');
                return;
            }

            setLoading('resetBtnText', 'resetSpinner', true);

            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('resetSuccess', `‚úÖ Password reset email sent to: ${email}\n\nCheck your inbox (and spam folder) for the reset link.`);
                document.getElementById('resetEmail').value = '';
                setLoading('resetBtnText', 'resetSpinner', false);

                setTimeout(() => showLogin(), 4000);

            } catch (error) {
                setLoading('resetBtnText', 'resetSpinner', false);
                console.error('Reset error:', error);
                
                let errorMessage = 'Failed to send reset email. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‚ùå No account found with this email address.\n\nPlease check the email or sign up for a new account.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = '‚ùå Invalid email address format.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'üåê Network error. Please check your connection.';
                }
                
                showError('resetError', errorMessage);
            }
        }

        async function checkUserSetup(user) {
            try {
                console.log('Initializing OAuth for user:', user.email);
                await SheetsAPI.init();
                console.log('OAuth initialized successfully');
                
                const userRow = await SheetsAPI.getUserByEmail(user.email);
                
                if (userRow && userRow.length > 0) {
                    console.log('User found in Sheets, redirecting to dashboard');
                    window.location.href = 'dashboard.html';
                } else {
                    console.log('User not in Sheets, redirecting to setup');
                    window.location.href = 'setup.html';
                }
            } catch (error) {
                console.error('Error during user setup check:', error);
                if (error.message && error.message.includes('popup')) {
                    alert('‚ö†Ô∏è Please allow popups for this site to continue.\n\nThe app needs Google Sheets access to save your data.');
                } else {
                    alert(`‚ö†Ô∏è Setup check failed: ${error.message}\n\nYou'll be redirected to setup. If this persists, please contact support.`);
                }
                window.location.href = 'setup.html';
            }
        }
    </script>
</body>
</html>
