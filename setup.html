<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - FitSync</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard">
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">Setting up...</p>
        </div>
    </div>

    <div class="container" style="max-width: 800px; margin: 40px auto;">
        <div class="card">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="font-size: 2rem; margin-bottom: 10px;">üéØ Let's Set Up Your Profile</h1>
                <p style="color: var(--text-secondary);">Tell us about your workout routine and schedule</p>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 40px; justify-content: center;">
                <div class="step active" id="step1Indicator" style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: var(--bg-dark); display: flex; align-items: center; justify-content: center; font-weight: 700;">1</div>
                    <span style="font-weight: 600;">Schedule</span>
                </div>
                <div class="step" id="step2Indicator" style="display: flex; align-items: center; gap: 10px; opacity: 0.5;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-weight: 700;">2</div>
                    <span>Workout</span>
                </div>
                <div class="step" id="step3Indicator" style="display: flex; align-items: center; gap: 10px; opacity: 0.5;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-weight: 700;">3</div>
                    <span>Partner</span>
                </div>
            </div>

            <div id="step1" class="setup-step">
                <h2 style="margin-bottom: 20px;">‚è∞ Your Morning Schedule</h2>
                <div class="form-group">
                    <label for="workTime">What time do you need to be at work?</label>
                    <input type="time" id="workTime" value="09:00">
                </div>
                <div class="form-group">
                    <label for="commute">Commute time (minutes)</label>
                    <input type="number" id="commute" value="12" min="0">
                </div>
                <div class="form-group">
                    <label for="grooming">Shower & grooming time (minutes)</label>
                    <input type="number" id="grooming" value="20" min="0">
                </div>
                <button onclick="nextStep(2)" class="btn btn-primary">Next: Setup Workout</button>
            </div>

            <div id="step2" class="setup-step" style="display: none;">
                <h2 style="margin-bottom: 20px;">üí™ Your Workout Routine</h2>
                <div id="workoutBuilder"></div>
                <button onclick="addWorkout()" class="btn btn-secondary" style="margin-top: 15px;">+ Add Exercise</button>
                <div class="alert alert-success" style="margin-top: 20px;">
                    <span>‚úÖ</span>
                    <div><strong>Total time:</strong> <span id="totalTime">0 minutes</span></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="nextStep(1)" class="btn btn-outline" style="flex: 1;">‚Üê Back</button>
                    <button onclick="nextStep(3)" class="btn btn-primary" style="flex: 2;">Next: Connect Partner</button>
                </div>
            </div>

            <div id="step3" class="setup-step" style="display: none;">
                <h2 style="margin-bottom: 20px;">üë• Connect Your Partner</h2>
                <div class="form-group">
                    <label for="partnerEmail">Partner's Email (Optional)</label>
                    <input type="email" id="partnerEmail" placeholder="partner@example.com">
                    <small style="color: var(--text-secondary);">They must have a FitSync account</small>
                </div>
                <div class="form-group">
                    <label for="telegram">Your Telegram Username (Optional)</label>
                    <input type="text" id="telegram" placeholder="@yourusername">
                    <small style="color: var(--text-secondary);">For 8pm alerts via @fitsync_workout_bot</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="nextStep(2)" class="btn btn-outline" style="flex: 1;">‚Üê Back</button>
                    <button onclick="completeSetup()" class="btn btn-primary" style="flex: 2;">üöÄ Complete Setup</button>
                </div>
            </div>
        </div>
    </div>

    <script src="config-secrets.js"></script>
    <script src="config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="sheets-api.js"></script>

    <script>
        firebase.initializeApp(CONFIG.firebase);
        const auth = firebase.auth();
        let currentUser = null;
        let workouts = [];

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                initSetup();
            }
        });

        function initSetup() {
            addWorkout('Press-ups', '50 reps in sets of 10', 8);
            addWorkout('Squats', '50 reps in sets of 10', 8);
            addWorkout('Sprints', '5 sets of 15 seconds', 4);
            addWorkout('Jump Rope', '5 sets of 1 minute', 7);
            addWorkout('Breathwork', 'Day-based video from playlist', 20);
        }

        function nextStep(step) {
            document.querySelectorAll('.setup-step').forEach(s => s.style.display = 'none');
            document.getElementById('step' + step).style.display = 'block';
            [1,2,3].forEach(i => {
                const indicator = document.getElementById('step' + i + 'Indicator');
                if (i < step) {
                    indicator.style.opacity = '1';
                    indicator.querySelector('div').style.background = 'var(--success)';
                } else if (i === step) {
                    indicator.style.opacity = '1';
                    indicator.querySelector('div').style.background = 'var(--primary)';
                } else {
                    indicator.style.opacity = '0.5';
                    indicator.querySelector('div').style.background = 'var(--border)';
                }
            });
        }

        function addWorkout(name = '', details = '', minutes = 0) {
            workouts.push({ id: Date.now() + Math.random(), name, details, minutes });
            renderWorkouts();
        }

        function removeWorkout(id) {
            workouts = workouts.filter(w => w.id !== id);
            renderWorkouts();
        }

        function renderWorkouts() {
            const container = document.getElementById('workoutBuilder');
            container.innerHTML = workouts.map((w, i) => `
                <div style="display: grid; grid-template-columns: 1fr 2fr 100px 40px; gap: 10px; margin-bottom: 10px;">
                    <input type="text" placeholder="Exercise" value="${w.name}" onchange="workouts[${i}].name = this.value" style="padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary);">
                    <input type="text" placeholder="Details" value="${w.details}" onchange="workouts[${i}].details = this.value" style="padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary);">
                    <input type="number" placeholder="Min" value="${w.minutes}" min="1" onchange="workouts[${i}].minutes = parseInt(this.value); updateTotal()" style="padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: var(--bg-dark); color: var(--text-primary);">
                    <button onclick="removeWorkout(${w.id})" style="padding: 10px; border: none; border-radius: 8px; background: var(--danger); color: white; cursor: pointer;">‚úï</button>
                </div>
            `).join('');
            updateTotal();
        }

        function updateTotal() {
            const total = workouts.reduce((sum, w) => sum + (w.minutes || 0), 0);
            document.getElementById('totalTime').textContent = total + ' minutes';
        }

        async function completeSetup() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            try {
                await SheetsAPI.init();
                const userId = await SheetsAPI.createUser({
                    name: currentUser.displayName,
                    email: currentUser.email,
                    workTime: document.getElementById('workTime').value,
                    commute: document.getElementById('commute').value,
                    grooming: document.getElementById('grooming').value,
                    telegram: document.getElementById('telegram').value
                });
                await SheetsAPI.createMultipleWorkouts(userId, workouts);
                await SheetsAPI.initializeUserMilestones(userId);
                const partnerEmail = document.getElementById('partnerEmail').value.trim();
                if (partnerEmail) {
                    await SheetsAPI.updateUserPartner(currentUser.email, partnerEmail);
                }
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('Setup error:', error);
                alert('Setup failed: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
    </script>
</body>
</html>
